services:
  device:
    build: ./device_layer
    container_name: ce_cms_device
    ports:
      - "5000:5000"
    volumes:
      - ./config:/app/config
      - ./results:/app/results
    environment:
      - LAYER=device
      - FOG_URL=http://fog:6000
    networks:
      - ce_cms_network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  fog:
    build: ./fog_layer
    container_name: ce_cms_fog
    ports:
      - "6000:6000"
    volumes:
      - ./config:/app/config
      - ./results:/app/results
    environment:
      - LAYER=fog
      - CLOUD_URL=http://cloud:7000
    depends_on:
      device:
        condition: service_healthy
    networks:
      - ce_cms_network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:6000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  cloud:
    build: ./cloud_layer
    container_name: ce_cms_cloud
    ports:
      - "7000:7000"
    volumes:
      - ./config:/app/config
      - ./results:/app/results
    environment:
      - LAYER=cloud
    depends_on:
      fog:
        condition: service_healthy
    networks:
      - ce_cms_network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:7000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  metrics:
    build: ./metrics
    container_name: ce_cms_metrics
    ports:
      - "8000:8000"
    volumes:
      - ./config:/app/config
      - ./results:/app/results
    environment:
      - LAYER=metrics
      - DEVICE_URL=http://device:5000
      - FOG_URL=http://fog:6000
      - CLOUD_URL=http://cloud:7000
    depends_on:
      device:
        condition: service_healthy
      fog:
        condition: service_healthy
      cloud:
        condition: service_healthy
    networks:
      - ce_cms_network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  attacks:
    build: ./attacks
    container_name: ce_cms_attacks
    volumes:
      - ./config:/app/config
      - ./results:/app/results
    environment:
      - DEVICE_URL=http://device:5000
      - FOG_URL=http://fog:6000
      - CLOUD_URL=http://cloud:7000
    depends_on:
      device:
        condition: service_healthy
      fog:
        condition: service_healthy
      cloud:
        condition: service_healthy
      metrics:
        condition: service_healthy
    networks:
      - ce_cms_network
    profiles:
      - attacks

  shutdown_monitor:
    build: ./metrics
    container_name: ce_cms_shutdown
    volumes:
      - ./config:/app/config
      - ./results:/app/results
    environment:
      - DEVICE_URL=http://device:5000
      - METRICS_URL=http://metrics:8000
    command: python shutdown_simulation.py
    depends_on:
      attacks:
        condition: service_started
      metrics:
        condition: service_healthy
    networks:
      - ce_cms_network
    profiles:
      - attacks

networks:
  ce_cms_network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.0.0/16